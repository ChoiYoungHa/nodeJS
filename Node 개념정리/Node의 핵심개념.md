# Node의 핵심개념

# 자바스크립트 런타임

- 노드는 자바스크립트 런타임, 런타임은 특정 언어로 만든 프로그램들을 실행할 수 있는 환경을 뜻합니다.
- 노드는 크롬 V8 자바스크립트 엔진으로 빌드된 자바스크립트 런타임입니다.
- 노드는 V8과 더불어 libuv 라는 라이브러리를 사용합니다. libuv는 노드의 특성인 이벤트 기반 논블로킹 I/O 모델을 구현하고 있다.

# 이벤트 기반

- 이벤트 기반이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식을 의미합니다. 이벤트로는 클릭이나 네트워크 요청등이 있다.
- 이벤트 기반 시스템에서는 이벤트가 발생할 때 무엇을 할지 미리 등록해 두어야한다. 이를 이벤트 리스너에 콜백함수를 등록한다고 표현한다.
- 발생한 이벤트가 없거나 발생했던 이벤트를 다 처리하면, 노드는 다음 이벤트가 발생할 때까지 대기한다.

---

## 이벤트 루프란?

- 여러 이벤트가 **동시에 발생했을 때 어떤 순서로 콜백함수를 호출**할지를 이벤트 루프가 판단한다.
- 이벤트 루프는 호출스택이 비어 있을 때만 태스크 큐에 있는 함수를 호출스택으로 가져온다.
- 이벤트 루프는 태스크 큐에 콜백이 들어올때 까지 계속 대기한다.

## 백그라운드란?

- setTimeout 같은 타이머나 이벤트 리스너들이 대기하는 곳. 자바스크립트가 아닌 다른 언어로 작성된 프로그램이라고 봐도 되며, 여러 작업이 동시에 실행될 수 있다.

## 태스크 큐란?

- 이벤트 발생 후, 백그라운드에서 태스크 큐로 타이머나 이벤트 리스너의 콜백 함수를 보낸다. 정해진 순서대로 콜백들이 줄을 서 있으므로 콜백 큐라고 부릅니다. 콜백들은 보통 완료된 순서대로 줄을 서 있지만 특정한 경우에는 순서가 바뀌기도 합니다.

## 이벤트 루프, 백그라운드, 태스크 큐의 실행흐름

```c
function run(){
	console.log('3초 후 실행');
}
console.log("시작");
setTimeout(run,3000);
console.log("끝");
```

- setTimeout이 호출스택에 진입 → 호출스택에서 setTimeout을 실행하면서 백그라운드로 보냄 → 백그라운드에서 3초를 센 후 run 함수를 태스크 큐로 보냄 (백그라운드에서 맡겨진 작업이 완료된 것) →
- 백그라운드에서 3초가 지난 후 실제 로직을 실행하기 위해서 태스크 큐로 보냄 → 이벤트 루프가 특정규칙에 따라 태스크 큐에있는 콜백함수를 실행함 해당 규칙에 따라 run 이 실행 됨→ 이벤트 루프는 태스크큐에 콜백함수가 들어올 때 까지 계속 대기함

```c
결과값
시작
끝
3초 후 실행
```

---

# 논블로킹 I/O

- 이벤트 루프를 잘 활용하면 오래 걸리는 작업을 효율적으로 처리 가능
- 논 블로킹은 이전 작업이 완료될 때까지 기다리지 않고 다음 작업을 수행
- 블로킹은 작업이 끝나야만 다음 작업을 수행하는 것을 의미
- 동시에 처리될 수 있는 I/O 작업이라도 논블로킹 방식으로 코딩하지 않으면 의미가 퇴색되므로 논 블로킹 방식으로 코딩하는 습관을 들여야함.
- setTimeout(콜백,0)은 코드를 논 블로킹으로 만들기 위해 사용하는 기법 중 하나

---

# 싱글스레드

- 노드는 논 블로킹, 싱글스레드 방식을 채택한다.
- 다만 노드가 싱글 스레드로 동작하지 않는 두가지 경우가 있다. 하나는 스레드 풀이고, 다른 하나는 워커 스레드이다.

---

# 서버로서의 노드

- 노드는 cpu 부하가 큰 작업에는 적합하지 않다. 작성된 코드는 모두 스레드 하나에서 처리된다.
- 코드가 cpu 연산을 많이 요구하면 스레드 하나가 혼자서 감당하기 어렵다.
- 노드는 개수는 많지만 크기는 작은 데이터를 실시간으로 주고받을 때 적합하다 예를들어 디스크 작업 I/O, 네트워크 나 데이터베이스, 실시간 채팅, 주식차트, json 데이터 제공하는 api 서버
- 멀티스레드 기능이 있긴하지만 그래도 이미지나 비디오처리 혹은 대규모 데이터처리 처럼  cpu를 많이 사용하는 작업을 위한 서버로는 권장하지 않음
- 그럼에도 노드를 사용하고 싶다면 AWS 람다, 구글 클라우드 펑션스 같은 서비스에서 노드로 cpu를 많이 사용하는 작업을 처리하는 것을 고려 해봐야함.
- 노드에는 웹서버가 자체 내장되어 있지만 나중에 서버 규모가 커지면 ngnix 등의 웹 서버를 노드 서버와 연결하여 사용해야한다.
- 노드는 생산성이 매우 좋지만 Go 처럼 비동기에 강점을 보이는 언어나 nginix 처럼 정적파일을 제공 로드벨런싱에 특화된 웹 서버에 비해 속도는 느리다. 다만 극단적인 성능이 필요하지 않는다면 이러한 단점은 노드의 생산성으로 어느정도 극복 가능하다.